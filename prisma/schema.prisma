generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String              @id @default(cuid())
  email        String              @unique
  name         String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  periodAnchor DateTime?
  passwordHash String?
  items        BudgetItem[]
  transactions ActualTransaction[]
}

model BudgetItem {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  type        ItemType
  name        String
  amountCents Int
  frequency   Frequency

  weeklyDay       Int?
  fortnightAnchor DateTime?
  monthDay        Int?

  startDate DateTime
  endDate   DateTime?

  weekendPolicy WeekendPolicy @default(FRIDAY_BEFORE)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NEW: Relationship to allocated transactions
  allocatedTransactions ActualTransaction[]
}

model ActualTransaction {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime
  amountCents   Int
  description   String
  category      String?
  source        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  generatedFrom String?
  isGenerated   Boolean  @default(false)
  reconciled    Boolean  @default(false)
  user          User     @relation(fields: [userId], references: [id])

  // NEW: Allocation and budget tracking
  isAllocated   Boolean  @default(false)
  budgetItemId  String?
  isOnTheDay    Boolean  @default(false)  // out-of-budget transactions
  budgetItem    BudgetItem? @relation(fields: [budgetItemId], references: [id])

  @@unique([userId, generatedFrom, date, amountCents])
  @@index([userId, date])
  @@index([userId, isAllocated])
  @@index([userId, isOnTheDay])
}

enum ItemType {
  INCOME
  EXPENSE
}

enum Frequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
}

enum WeekendPolicy {
  FRIDAY_BEFORE   // move Sat/Sun to previous Friday  (current behavior)
  AS_IS           // keep the exact calendar day (allow Saturday/Sunday)
}
